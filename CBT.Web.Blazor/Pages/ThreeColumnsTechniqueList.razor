@page "/diary/three-columns"

@using CBT.Web.Blazor.Data
@using CBT.Web.Blazor.Data.Identity;
@using CBT.Web.Blazor.Data.Model;
@using CBT.Web.Blazor.Services;

@using Microsoft.AspNetCore.Identity;
@using Syncfusion.Blazor.Buttons;
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Grids;

@inject AutomaticThoughtsService AutomaticThoughtsService
@inject SfDialogService SfDialogService;
@inject AuthenticationStateProvider GetAuthenticationStateAsync
@inject UserManager<User> UserManager;

@inject IJSRuntime jsRuntime;

<PageTitle>КПТ - Техника трёх колонок</PageTitle>

<h1>Техника трёх колонок</h1>

<div class="alert alert-secondary mt-4">
    Используйте технику трёх колонок каждый раз, когда у Вас портится настроение или возникает тревога.<br/>
    @{
        if (ShowButtons)
        {
            <NavLink class="nav-link" href="diary/three-columns/example">
                <span class="oi oi-list-rich" aria-hidden="true"></span> Примеры проработок "Техники трех колонок"
            </NavLink>
        }
    }
</div>

@if (cognitiveErrors == null)
{
    <p><em>Загрузка...</em></p>
}
else
{
    <SfButton IconCss="oi oi-plus" Content="Добавить" IsPrimary="true" @onclick="AddBtnClick" CssClass="@(ShowButtons? "" : "hidden")" />
    <br />
    <SfGrid @ref="DataGrid" EnableAdaptiveUI="true" AdaptiveUIMode="AdaptiveMode.Both" DataSource="items" AllowTextWrap="true">
        <GridColumns>
            <GridColumn Visible="ShowButtons" HeaderText="">
                <Template>
                    @{
                        var model = (ThreeColumnsTechniqueRecordModel)context;
                        if (!model.Sent)
                        {
                            <button class="btn btn-success" @onclick="@(async () => await SendBtnClick(model.Id))">
                                Отправить
                            </button>
                        }
                        else
                        {
                            <text>
                                <i class="oi oi-circle-check" style="color: blue;" /> Отправлено!
                            </text>
                            if (reviewExists.TryGetValue(model.Id, out var exists) && !exists)
                            {
                                <text>
                                    <br />
                                    <i class="oi oi-circle-check" style="color: red;" /> Недоступно!
                                </text>
                            }
                            else
                            {
                                <button class="btn btn-primary" @onclick="@(async () => await CheckReviewBtnClick(model.Id))">
                                    Проверить
                                </button>
                            }
                        }
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(ThreeColumnsTechniqueRecordModel.Thought)"
                        HeaderText="Автоматическая мысль" />
            <GridColumn Field="@nameof(ThreeColumnsTechniqueRecordModel.Errors)"
                        HeaderText="Когнитивные искажения">
                <Template>
                    @{
                        var errors = ((ThreeColumnsTechniqueRecordModel)context).Errors;
                        foreach (var error in errors)
                        {
                            <span>@cognitiveErrors[(int)error].Title</span>
                            <br />
                        }
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(ThreeColumnsTechniqueRecordModel.RationalAnswer)"
                        HeaderText="Рациональный ответ" />
            <GridColumn Visible="ShowButtons" Field="@nameof(ThreeColumnsTechniqueRecordModel.Id)"
                        HeaderText="">
                <Template>
                    @{
                        var id = ((ThreeColumnsTechniqueRecordModel)context).Id;

                        <button class="btn btn-danger" @onclick="@(async () => await DeleteBtnClick(id))">
                            <i class="oi oi-trash" /> Удалить
                        </button>
                        <button class="btn btn-success" @onclick="@(async () => await EditBtnClick(id))">
                            <i class="oi oi-pencil" /> Изменить
                        </button>
                    }
                </Template>
            </GridColumn>
        </GridColumns>
    </SfGrid>

    <ThreeColumnsTechniqueEdit @ref="EditableThought" CognitiveErrors="cognitiveErrors">
    </ThreeColumnsTechniqueEdit>

    <ThoughtReviewPopup @ref="ThoughtReview" CognitiveErrors="cognitiveErrors">
    </ThoughtReviewPopup>
}

@code {
    SfGrid<ThreeColumnsTechniqueRecordModel> DataGrid;

    ThreeColumnsTechniqueEdit EditableThought;
    ThoughtReviewPopup ThoughtReview;

    private IEnumerable<ThreeColumnsTechniqueRecordModel> items;
    private Dictionary<int, CognitiveErrorModel> cognitiveErrors;

    private string? currentUserId;

    private Dictionary<int, bool> reviewExists;

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await GetCurrentUserId();

        items = await AutomaticThoughtsService.GetAllThoughts(currentUserId);
        cognitiveErrors = AutomaticThoughtsService.GetAllCognitiveErrors();

        reviewExists = new Dictionary<int, bool>();
    }

    public void AddBtnClick()
    {
        if (EditableThought.IsEdit == true)
        {
            EditableThought.Model = new ThreeColumnsTechniqueRecordModel();
        }

        EditableThought.IsEdit = false;
        EditableThought.IsVisible = true;
        EditableThought.SuccessCallback = async () => await Refresh();
    }

    public async Task DeleteBtnClick(int id)
    {
        var confirmed = await SfDialogService.ConfirmAsync("Вы действительно хотите удалить запись?", "Подтверждение действия", new()
            {
                ShowCloseIcon = true,
                PrimaryButtonOptions = new()
                {
                    IconCss = "oi oi-trash"
                },
                CancelButtonOptions = new()
                {
                    Content = "Отмена",
                }
            });

        if (confirmed)
        {
            await AutomaticThoughtsService.DeleteThought(id);
            await Refresh();
        }
    }

    public async Task EditBtnClick(int id)
    {
        var model = await AutomaticThoughtsService.GetThought(id);
        if (model != null)
        {
            EditableThought.Model = model;
            EditableThought.IsEdit = true;
            EditableThought.IsVisible = true;
            EditableThought.SuccessCallback = async () => await Refresh();
        }
    }

    public async Task SendBtnClick(int id)
    {
        await AutomaticThoughtsService.SendThoughtToPsychologist(id);

        items.First(x => x.Id == id).Sent = true;
    }

    public async Task CheckReviewBtnClick(int id)
    {
        var review = await AutomaticThoughtsService.GetPsychologistReview(id);
        if (review != null)
        {
            ThoughtReview.Model = review;
            ThoughtReview.IsVisible = true;
            reviewExists[id] = true;
        }
        else
        {
            reviewExists[id] = false;
        }
    }

    private async Task Refresh()
    {
        var currentUserId = await GetCurrentUserId();

        items = await AutomaticThoughtsService.GetAllAutomaticThoughts(currentUserId);

        await InvokeAsync(StateHasChanged);
        await DataGrid.Refresh();
    }

    protected virtual async Task<string?> GetCurrentUserId()
    {
        var authstate = await GetAuthenticationStateAsync.GetAuthenticationStateAsync();
        var user = authstate.User;
        var currentUserId = UserManager.GetUserId(user);

        return currentUserId;
    }

    protected virtual bool ShowButtons => true;
}
